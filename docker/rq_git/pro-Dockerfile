FROM rebase/pro-web

RUN apk update && \
    apk add \
        --no-cache \
        git \
        openssh \
        py-virtualenv && \
    mkdir \
        -p \
        /var/run/sshd \
        /root/.ssh && \
    adduser \
        -D \
        -g "Rebase Git" \
        git && \
    echo "git:rebase_is_da_bomb" | chpasswd && \
    virtualenv \
        -p python2.7 \
        /venv/super && \
    /venv/super/bin/pip install supervisor && \
    ssh-keygen -A

COPY sshd_config /etc/ssh/sshd_config

COPY supervisor.conf /etc/git/supervisor.conf

COPY filter /usr/bin/filter

USER git
WORKDIR /home/git
RUN mkdir .ssh && \
    chmod 700 .ssh && \
    touch .ssh/authorized_keys && \
    chmod 600 .ssh/authorized_keys
USER root
WORKDIR /
EXPOSE 22
ENTRYPOINT ["/venv/super/bin/supervisord", "--configuration", "/etc/git/supervisor.conf"]
