FROM alpine

RUN apk update && \
    apk add \
        --no-cache \
        git \
        libpq \
        py-virtualenv \
        python3 && \
    pyvenv /venv/rq && \
    virtualenv /venv/rq_p2

COPY ./requirements.txt ./requirements_p2.txt /

COPY ./wheels /wheels

COPY ./py2_wheels /py2_wheels

RUN source /venv/rq/bin/activate && \
    pip install \
        --no-cache-dir \
        --requirement /requirements.txt \
        --find-links /wheels && \
    deactivate && \
    source /venv/rq_p2/bin/activate && \
    pip install \
        --no-cache-dir \
        --requirement /requirements_p2.txt \
        --find-links /py2_wheels && \
    rm -rf /wheels && \
    rm -rf /py2_wheels

WORKDIR /api

CMD ["/venv/rq/bin/python", "-m", "rebase.scripts.rq_default"]
